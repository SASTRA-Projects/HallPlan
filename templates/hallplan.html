<!-- Copyright 2025 Harikrishna Srinivasan

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. -->


{% extends "layout.html" %}

{% block title %}Hall Plan{% endblock %}

{% if table %}
{% block head %}
<meta name="description"
      content="Display examination hall plan and filter by date or slot number.">
<style>
    .content-wrapper {
        max-width: 1200px;
        margin-bottom: 1rem;
        padding: 0 1rem;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    h1 {
        text-align: left;
        margin-bottom: 0;
    }
    .filter-form {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem;
        background-color: var(--input-bg-dark);
        border: 1px solid var(--input-border-dark);
        border-radius: 0.5rem;
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .filter-form label {
        font-weight: bold;
    }
    .filter-form select {
        padding: 8px 12px;
        border: 1px solid var(--input-border-dark);
        border-radius: 0.5rem;
        background-color: var(--background-dark);
        color: var(--text-dark);
        min-width: 150px;
        color-scheme: dark;
    }
    .search-btn {
        background-color: #3b82f6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 0.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    [data-theme="light"] .filter-form {
        background-color: #f9f9f9;
        border-color: var(--input-border-light);
    }
    [data-theme="light"] .filter-form select {
        border-color: var(--input-border-light);
        background-color: #fff;
        color: var(--text-light);
        color-scheme: light;
    }
    .download-btn {
        background-color: #4a407c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 0.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .download-btn:hover {
        background-color: #5f52a0;
        color: white;
    }
    [data-theme="light"] .download-btn {
        background-color: #5c6bc0;
        color: white;
    }
    [data-theme="light"] .download-btn:hover {
        background-color: #7986cb;
        color: white;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        box-shadow: var(--shadow);
        overflow: hidden;
        border: 1px solid var(--input-border-dark);
    }
    th, td {
        text-align: right;
        padding: 12px;
        border-bottom: 1px solid var(--input-border-dark);
        border-right: 1px solid var(--input-border-dark);
    }
    th:last-child, td:last-child {
        border-right: none;
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    thead tr {
        background-color: #1f1a36;
        color: var(--text-dark);
        font-weight: bold;
    }
    tbody tr.row-even {
        background-color: var(--input-bg-dark);
    }
    [data-theme="light"] table {
        border: 1px solid var(--input-border-light);
    }
    [data-theme="light"] th, [data-theme="light"] td {
        border-bottom: 1px solid var(--input-border-light);
        border-right: 1px solid var(--input-border-light);
    }
    [data-theme="light"] thead tr {
        background-color: #f2f2f2;
        color: var(--text-light);
    }
    [data-theme="light"] tbody tr.row-even {
        background-color: #f9f9f9;
    }
    td[rowspan] {
        vertical-align: top;
        font-weight: bold;
    }
</style>
{% endblock %}
{% block content %}
<div class="content-wrapper">
    <div class="page-header">
        <h1>Examination Hall Plan</h1>
        <button class="download-btn" onclick="downloadPlan()">Download as HTML</button>
    </div>
    <form action="/hallplan" method="POST" class="filter-form">
        <div class="filter-group">
            <label for="date-select">Date:</label>
            <select name="date" id="date-select">
                <option value="" disabled selected>{{ date or "All Dates" }}</option>
                {% for date in dates %}
                    <option value="{{ date }}">{{ date }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="slot-select">Slot:</label>
            <select name="slot" id="slot-select">
                <option value="" disabled selected>{{ slot_no or "All Slots" }}</option>
                {% for slot in slots %}
                    <option value="{{ slot }}">{{ slot }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="search-btn">Search</button>
    </form>
    <table id="hallPlanTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Slot</th>
                <th>Course Code</th>
                <th>Section</th>
                <th>Room No</th>
                <th>Register No</th>
            </tr>
        </thead>
        <tbody>
            {% for row in table %}
                {% set row_class = loop.cycle("row-odd", "row-even") %}
                {% set num_halls = row.halls | length %}
                {% if num_halls > 0 %}
                    {% for hall, registers in row.halls.items() %}
                        <tr class="{{ row_class }}">
                            {% if loop.first %}
                                <td rowspan="{{ num_halls }}">{{ row.date }}</td>
                                <td rowspan="{{ num_halls }}">{{ row.slot_no }}</td>
                                <td rowspan="{{ num_halls }}">{{ row.course_code }}</td>
                                <td rowspan="{{ num_halls }}">{{ row.description }}</td>
                            {% endif %}
                            <td>{{ hall }}</td>
                            <td>{{ registers }}</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    function downloadPlan() {
        const titleText = document.querySelector("h1").textContent;
        const tableHTML = document.getElementById("hallPlanTable").outerHTML;
        const filename = titleText.replace(/[ -]/g, "_").toLowerCase() + ".html";
        const simplifiedStyles = `
            body {
                font-family: Arial, sans-serif;
                padding: 2rem;
                color: #333;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                border: 1px solid #666;
            }
            th, td {
                text-align: right;
                padding: 8px;
                border: 1px solid #999;
            }
            th {
                background-color: #e0e0e0;
                font-weight: bold;
                color: #333;
            }
            td {
                background-color: #f9f9f9;
            }
            td[rowspan] {
                vertical-align: top;
                font-weight: bold;
            }`;
        const htmlContent = `
            <!DOCTYPE html>
            <html lang="en-US">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${titleText}</title>
                <style>
                    ${simplifiedStyles}
                </style>
            </head>
            <body>
                <h1>${titleText}</h1>
                ${tableHTML}
            </body>
            </html>`;
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}
{% else %}
<h1>No plan found!</h1>
{% endif %}
